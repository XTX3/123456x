<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>شات عضو - مسؤول (Firebase) - الإدارة</title>
<style>
body{font-family:system-ui,Segoe UI,Arial;display:flex;gap:16px;padding:16px;background:#f5f7fb}
.panel{background:white;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;flex:1;min-width:320px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.hidden{display:none}
#chatList{max-height:60vh;overflow:auto;border:1px solid #eee;padding:8px;border-radius:6px}
.chat-item{padding:8px;border-bottom:1px solid #f0f0f0;cursor:pointer}
.chat-item:hover{background:#f9fbff}
.small{font-size:13px;color:#666}
.role-badge{font-size:12px;padding:4px 6px;border-radius:6px;background:#eee}
.flex{display:flex;gap:12px}
#chatModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center}
#chatBox{background:#fff;width:90%;max-width:500px;border-radius:8px;padding:16px;display:flex;flex-direction:column;height:70vh}
#messages{flex:1;overflow:auto;border:1px solid #eee;padding:12px;border-radius:6px;background:#fff;display:flex;flex-direction:column;margin-bottom:12px}
.msg{margin:8px 0;max-width:75%}
.me{align-self:flex-end;background:#dcf8c6;padding:8px;border-radius:8px}
.other{align-self:flex-start;background:#fff;padding:8px;border-radius:8px;border:1px solid #eee}
.msg-row{display:flex;flex-direction:column}
form{display:flex;gap:8px;margin-top:8px}
input[type="text"]{flex:1;padding:10px;border-radius:6px;border:1px solid #ddd}
button{padding:10px 12px;border-radius:6px;border:0;background:#2563eb;color:white;cursor:pointer}
.closeBtn{align-self:flex-end;background:#ef4444;color:white;padding:4px 8px;border-radius:6px;border:none;margin-bottom:8px;cursor:pointer}
@media(max-width:900px){body{flex-direction:column}}
</style>
</head>
<body>

<!-- تسجيل / دخول -->
<div class="panel" style="max-width:400px;">
  <div class="header">
    <h3>تسجيل / دخول</h3>
    <span id="userStatus" class="small">غير متصل</span>
  </div>
  <div id="authForms">
    <input id="liEmail" type="email" placeholder="إيميل" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd">
    <input id="liPass" type="password" placeholder="كلمة مرور" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd">
    <button id="loginBtn">دخول</button>
    <button id="signupBtn" style="background:#10b981">تسجيل جديد</button>
  </div>
  <div id="signedInPanel" class="hidden">
    <div class="flex" style="align-items:center;justify-content:space-between">
      <div>
        <div id="displayEmail" style="font-weight:600"></div>
        <div id="displayRole" class="small role-badge" style="margin-top:6px"></div>
      </div>
      <div>
        <button id="logoutBtn" style="background:#ef4444">خروج</button>
      </div>
    </div>
  </div>
</div>

<!-- لوحة الإدارة (قائمة الدردشات) -->
<div class="panel" style="flex:2;min-width:480px;">
  <div class="header">
    <h3>شات العضو ↔ المسؤول</h3>
  </div>

  <div id="adminView" class="hidden">
    <h4>قائمة المحادثات</h4>
    <div id="chatList"></div>
  </div>

  <div id="memberView" class="hidden">
    <h4>محادثتك مع المسؤول</h4>
    <button id="openMemberChatBtn">افتح المحادثة</button>
  </div>
</div>

<!-- نافذة الدردشة -->
<div id="chatModal">
  <div id="chatBox">
    <button class="closeBtn" onclick="closeChat()">✖ اغلاق</button>
    <div id="messages"></div>
    <form id="sendForm" autocomplete="off">
      <input id="messageInput" type="text" placeholder="اكتب رسالة..." autocomplete="off"/>
      <button type="submit">إرسال</button>
    </form>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// إعدادات Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDdPSV6OSPzqgdC5xWWfOCH2msTefFyoig",
  authDomain: "uusuf-535ce.firebaseapp.com",
  projectId: "uusuf-535ce",
  storageBucket: "uusuf-535ce.appspot.com",
  messagingSenderId: "1091306629647",
  appId: "1:1091306629647:web:f9b1bdac9d179260f4117a",
  measurementId: "G-KL6PGCZ04P"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// إعداد البريد الخاص بالمسؤول
const adminEmail = "uusuf1212@gmail.com";

// عناصر الصفحة
const signupBtn = document.getElementById('signupBtn');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const liEmail = document.getElementById('liEmail');
const liPass = document.getElementById('liPass');
const userStatus = document.getElementById('userStatus');
const authForms = document.getElementById('authForms');
const signedInPanel = document.getElementById('signedInPanel');
const displayEmail = document.getElementById('displayEmail');
const displayRole = document.getElementById('displayRole');
const adminView = document.getElementById('adminView');
const memberView = document.getElementById('memberView');
const chatList = document.getElementById('chatList');
const openMemberChatBtn = document.getElementById('openMemberChatBtn');
const chatModal = document.getElementById('chatModal');
const messagesDiv = document.getElementById('messages');
const sendForm = document.getElementById('sendForm');
const messageInput = document.getElementById('messageInput');

let currentUser = null;
let currentRole = null;
let unsubscribeChatList = null;
let currentChatId = null;

// تسجيل جديد
signupBtn.addEventListener('click', async () => {
  try {
    await auth.createUserWithEmailAndPassword(liEmail.value, liPass.value);
    alert("تم إنشاء الحساب، الآن سجل الدخول");
  } catch (e) { alert(e.message) }
});

// تسجيل دخول
loginBtn.addEventListener('click', async () => {
  try {
    await auth.signInWithEmailAndPassword(liEmail.value, liPass.value);
  } catch (e) { alert(e.message) }
});

// خروج
logoutBtn.addEventListener('click', async () => {
  if(unsubscribeChatList) unsubscribeChatList();
  await auth.signOut();
  location.reload();
});

// فتح وإغلاق نافذة الدردشة
function openChat(chatId){
  currentChatId = chatId;
  chatModal.style.display = "flex";
  listenForMessages();
}
function closeChat(){
  chatModal.style.display = "none";
  if(unsubscribeMessages) unsubscribeMessages();
}

// استماع للرسائل
let unsubscribeMessages = null;
function listenForMessages(){
  if(!currentChatId) return;
  if(unsubscribeMessages) unsubscribeMessages();
  unsubscribeMessages = db.collection('chats').doc(currentChatId)
    .collection('messages').orderBy('createdAt')
    .onSnapshot(snapshot=>{
      messagesDiv.innerHTML='';
      snapshot.forEach(doc=>{
        const m = doc.data();
        const isMine = m.from === currentUser.email;
        const row = document.createElement('div');
        row.className = 'msg-row';
        const box = document.createElement('div');
        box.className = 'msg ' + (isMine ? 'me' : 'other');
        box.textContent = m.text;
        row.appendChild(box);
        messagesDiv.appendChild(row);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
}

// إرسال رسالة
sendForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const text = messageInput.value.trim();
  if(!text) return;
  const msg = {
    text,
    from: currentUser.email,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  const chatRef = db.collection('chats').doc(currentChatId);
  await chatRef.collection('messages').add(msg);
  await chatRef.set({
    email: currentUser.email,
    displayName: currentUser.displayName || currentUser.email,
    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
  }, {merge:true});
  messageInput.value='';
});

// حالة المستخدم
auth.onAuthStateChanged(async user=>{
  currentUser = user;
  if(user){
    userStatus.textContent = 'متصل';
    authForms.style.display = 'none';
    signedInPanel.classList.remove('hidden');
    displayEmail.textContent = user.email;

    currentRole = (user.email.toLowerCase() === adminEmail.toLowerCase()) ? 'admin' : 'member';
    displayRole.textContent = currentRole === 'admin' ? 'مسؤول' : 'عضو';

    if(currentRole==='admin'){
      adminView.classList.remove('hidden');
      memberView.classList.add('hidden');
      startAdminChatListListener();
    } else {
      memberView.classList.remove('hidden');
      adminView.classList.add('hidden');
      // جعل المحادثة تفتح تلقائيًا للعضو
      currentChatId = user.email;
      openMemberChatBtn.onclick = ()=> openChat(currentChatId);
      openChat(currentChatId);
    }

  } else {
    userStatus.textContent='غير متصل';
    authForms.style.display='block';
    signedInPanel.classList.add('hidden');
    adminView.classList.add('hidden');
    memberView.classList.add('hidden');
  }
});

// قائمة المحادثات للمسؤول
function startAdminChatListListener(){
  chatList.innerHTML='جارٍ التحميل...';
  unsubscribeChatList = db.collection('chats')
    .orderBy('lastUpdated','desc')
    .onSnapshot(snap=>{
      chatList.innerHTML='';
      if(snap.empty) chatList.innerHTML='<div class="small">لا توجد محادثات</div>';
      snap.forEach(doc=>{
        const data = doc.data();
        const id = doc.id;
        const el = document.createElement('div');
        el.className='chat-item';
        el.innerHTML = `
          <strong>${data.displayName || id}</strong>
          <div class="small">${data.email || ''}</div>
          <button onclick="openChat('${id}')">فتح الدردشة</button>
        `;
        chatList.appendChild(el);
      });
    });
}
</script>
</body>
</html>
